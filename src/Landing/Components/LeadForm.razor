@using System.ComponentModel.DataAnnotations
@using Landing.Services
@inject ManagerApiClient ApiClient
@inject NavigationManager NavigationManager

<div class="lead-form-container">
    @if (_submitted)
    {
        <div class="success-message">
            <div class="success-icon">✓</div>
            <h3>Obrigado pelo seu interesse!</h3>
            <p>Recebemos suas informações e entraremos em contato em breve.</p>
        </div>
    }
    else
    {
        <EditForm Model="_model" OnValidSubmit="HandleSubmit" class="lead-form">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="name">Nome Completo *</label>
                <InputText id="name" @bind-Value="_model.Name" 
                           placeholder="Seu nome" 
                           disabled="@_isSubmitting" />
                <ValidationMessage For="@(() => _model.Name)" />
            </div>

            <div class="form-group">
                <label for="email">Email *</label>
                <InputText id="email" type="email" @bind-Value="_model.Email" 
                           placeholder="seu@email.com" 
                           disabled="@_isSubmitting" />
                <ValidationMessage For="@(() => _model.Email)" />
            </div>

            <div class="form-group">
                <label for="phone">Telefone *</label>
                <InputText id="phone" @bind-Value="_model.Phone" 
                           placeholder="(11) 98765-4321" 
                           disabled="@_isSubmitting" />
                <ValidationMessage For="@(() => _model.Phone)" />
            </div>

            <div class="form-group">
                <label for="message">Mensagem (Opcional)</label>
                <InputTextArea id="message" @bind-Value="_model.Message" 
                               placeholder="Como podemos ajudar você?"
                               rows="4"
                               disabled="@_isSubmitting" />
                <ValidationMessage For="@(() => _model.Message)" />
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="error-message">
                    <span class="error-icon">⚠</span>
                    @_errorMessage
                </div>
            }

            <button type="submit" class="btn-submit" disabled="@_isSubmitting">
                @if (_isSubmitting)
                {
                    <span class="spinner"></span>
                    <span>Enviando...</span>
                }
                else
                {
                    <span>Enviar Mensagem</span>
                }
            </button>
        </EditForm>
    }
</div>

@code {
    [Parameter]
    public string Source { get; set; } = "Landing";

    [Parameter]
    public string? ServiceInterest { get; set; }

    [Parameter]
    public EventCallback OnSubmitted { get; set; }

    private FormModel _model = new();
    private bool _isSubmitting;
    private bool _submitted;
    private string? _errorMessage;

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Capturar parâmetros UTM da URL
            var utmSource = GetUrlParameter("utm_source");
            var utmCampaign = GetUrlParameter("utm_campaign");
            var utmMedium = GetUrlParameter("utm_medium");
            var pagePath = GetCurrentPath();
            var referrer = GetReferrer();

            var dto = new CreateLeadDto(
                Name: _model.Name,
                Email: _model.Email,
                Phone: _model.Phone,
                Message: _model.Message,
                Source: Source,
                UtmSource: utmSource,
                UtmCampaign: utmCampaign,
                UtmMedium: utmMedium,
                PagePath: pagePath,
                Referrer: referrer,
                ServiceInterest: ServiceInterest
            );

            var response = await ApiClient.CreateLeadAsync(dto);

            if (response.Success)
            {
                _submitted = true;
                _model = new(); // Reset form
                await OnSubmitted.InvokeAsync();
            }
            else
            {
                _errorMessage = response.ErrorMessage ?? "Erro ao enviar. Tente novamente.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "Erro inesperado. Por favor, tente novamente mais tarde.";
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    public sealed class FormModel
    {
        [Required(ErrorMessage = "Nome é obrigatório")]
        [MinLength(2, ErrorMessage = "Nome deve ter pelo menos 2 caracteres")]
        [MaxLength(100, ErrorMessage = "Nome muito longo")]
        public string Name { get; set; } = "";

        [Required(ErrorMessage = "Email é obrigatório")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Telefone é obrigatório")]
        [CustomValidation(typeof(FormModel), nameof(ValidateBrazilianPhone))]
        public string Phone { get; set; } = "";

        [MaxLength(500, ErrorMessage = "Mensagem muito longa")]
        public string? Message { get; set; }

        public static ValidationResult? ValidateBrazilianPhone(string phone, ValidationContext context)
        {
            if (string.IsNullOrWhiteSpace(phone))
                return ValidationResult.Success;

            // Remove todos os caracteres não numéricos
            var cleanPhone = System.Text.RegularExpressions.Regex.Replace(phone, @"[^\d]", "");

            // Deve ter entre 10 e 11 dígitos
            if (cleanPhone.Length < 10 || cleanPhone.Length > 11)
                return new ValidationResult("Telefone deve ter 10 ou 11 dígitos");

            // Se tem 11 dígitos, deve começar com 9 (celular)
            if (cleanPhone.Length == 11 && !cleanPhone.StartsWith("9"))
                return new ValidationResult("Telefone celular deve começar com 9");

            // Códigos de área válidos (primeiro dígito do DDD)
            var validAreaCodes = new[] { "1", "2", "3", "4", "5", "6", "7", "8", "9" };
            var areaCode = cleanPhone.Substring(0, 1);
            if (!validAreaCodes.Contains(areaCode))
                return new ValidationResult("Código de área inválido");

            return ValidationResult.Success;
        }
    }

    private string? GetUrlParameter(string paramName)
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            return query.TryGetValue(paramName, out var values) ? values.FirstOrDefault() : null;
        }
        catch
        {
            return null;
        }
    }

    private string? GetCurrentPath()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            return uri.AbsolutePath;
        }
        catch
        {
            return null;
        }
    }

    private string? GetReferrer()
    {
        try
        {
            // Em Blazor Server, podemos tentar acessar via JavaScript
            // Por enquanto, retornamos null - pode ser implementado com JS interop se necessário
            return null;
        }
        catch
        {
            return null;
        }
    }
}
